<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>刷视频</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <style>
        html, body { height: 100%; margin: 0; padding: 0; background: #000; }
        #video-list { height: 100vh; width: 100vw; overflow: hidden; position: relative; }
        .video-container { height: 100vh; width: 100vw; display: flex; flex-direction: column; align-items: center; justify-content: center; position: absolute; top: 0; left: 0; transition: transform 0.4s; }
        video { max-height: 80vh; max-width: 100vw; background: #000; }
        .title { color: #fff; font-size: 1.2em; position: absolute; top: 20px; left: 20px; z-index: 2; }
        .desc { color: #fff; font-size: 1em; position: absolute; bottom: 80px; left: 20px; z-index: 2; max-width: 80vw; }
        .action-buttons { position: absolute; right: 20px; bottom: 100px; display: flex; flex-direction: column; gap: 20px; }
        .action-button { background: none; border: none; color: white; font-size: 24px; cursor: pointer; display: flex; flex-direction: column; align-items: center; }
        .action-button i { font-size: 32px; margin-bottom: 5px; }
        .action-button span { font-size: 14px; }
        .like-button.active { color: #ff2d55; }
        .loading { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; font-size: 20px; }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
</head>
<body>
    <div id="video-list"></div>
    <div id="loading" class="loading" style="display: none;">加载中...</div>
    <script>
        let page = 1;
        let videos = [];
        let current = 0;
        let loading = false;
        let touchStartY = 0;
        let touchStartX = 0;
        let isScrolling = false;
        let currentVideo = null;

        function showLoading() {
            document.getElementById('loading').style.display = 'block';
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        function loadVideos(cb) {
            if (loading) return;
            loading = true;
            showLoading();
            fetch(`/api/videos?page=${page}`)
                .then(res => res.json())
                .then(data => {
                    videos = videos.concat(data.videos);
                    if (cb) cb();
                    loading = false;
                    hideLoading();
                })
                .catch(error => {
                    console.error('加载视频失败:', error);
                    loading = false;
                    hideLoading();
                });
        }

        function toggleLike(videoId) {
            const likeButton = document.querySelector('.like-button');
            fetch(`/api/videos/${videoId}/like`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(res => res.json())
            .then(data => {
                likeButton.classList.toggle('active');
            })
            .catch(error => {
                console.error('点赞失败:', error);
            });
        }

        function showVideo(idx) {
            if (idx < 0 || idx >= videos.length) return;
            current = idx;
            const v = videos[idx];
            
            // 停止当前视频播放
            if (currentVideo) {
                currentVideo.pause();
            }

            document.getElementById('video-list').innerHTML = `
                <div class="video-container">
                    <div class="title">${v.title}</div>
                    <video src="${v.file_path}" controls autoplay loop></video>
                    <div class="desc">${v.description || ''}</div>
                    <div class="action-buttons">
                        <button class="action-button like-button" onclick="toggleLike('${v.id}')">
                            <i class="fas fa-heart"></i>
                            <span>点赞</span>
                        </button>
                        <button class="action-button">
                            <i class="fas fa-comment"></i>
                            <span>评论</span>
                        </button>
                        <button class="action-button">
                            <i class="fas fa-share"></i>
                            <span>分享</span>
                        </button>
                    </div>
                </div>
            `;

            // 保存当前视频元素引用
            currentVideo = document.querySelector('video');
        }

        // 触摸事件处理
        document.addEventListener('touchstart', e => {
            touchStartY = e.touches[0].clientY;
            touchStartX = e.touches[0].clientX;
            isScrolling = false;
        });

        document.addEventListener('touchmove', e => {
            const touchY = e.touches[0].clientY;
            const touchX = e.touches[0].clientX;
            const deltaY = touchY - touchStartY;
            const deltaX = touchX - touchStartX;
            
            // 判断是垂直滑动还是水平滑动
            if (Math.abs(deltaY) > Math.abs(deltaX)) {
                isScrolling = true;
                e.preventDefault(); // 防止页面滚动
            }
        }, { passive: false });

        document.addEventListener('touchend', e => {
            if (isScrolling) return;
            
            const touchEndY = e.changedTouches[0].clientY;
            const deltaY = touchEndY - touchStartY;
            
            if (Math.abs(deltaY) > 50) {
                if (deltaY > 0 && current > 0) {
                    showVideo(current - 1); // 下滑
                } else if (deltaY < 0) {
                    if (current < videos.length - 1) {
                        showVideo(current + 1); // 上滑
                    } else {
                        page++;
                        loadVideos(() => showVideo(current + 1));
                    }
                }
            }
        });

        // 键盘上下切换
        document.addEventListener('keydown', e => {
            if (e.key === 'ArrowUp') {
                if (current > 0) showVideo(current - 1);
            } else if (e.key === 'ArrowDown') {
                if (current < videos.length - 1) showVideo(current + 1);
                else {
                    page++;
                    loadVideos(() => showVideo(current + 1));
                }
            }
        });

        // 首次加载
        loadVideos(() => showVideo(0));
    </script>
</body>
</html> 